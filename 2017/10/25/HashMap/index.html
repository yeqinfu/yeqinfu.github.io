<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>HashMap相关 | Vencent Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="HashMap继承AbstractMap，而AbstractMap实现了map接口 123456789101112131415161718110111    public boolean containsValue(Object value) &amp;#123;112        Iterator&amp;lt;Entry&amp;lt;K,V&amp;gt;&amp;gt; i = entrySet().iterator();11">
<meta name="keywords" content="code">
<meta property="og:type" content="article">
<meta property="og:title" content="HashMap相关">
<meta property="og:url" content="http://yoursite.com/2017/10/25/HashMap/index.html">
<meta property="og:site_name" content="Vencent Blog">
<meta property="og:description" content="HashMap继承AbstractMap，而AbstractMap实现了map接口 123456789101112131415161718110111    public boolean containsValue(Object value) &amp;#123;112        Iterator&amp;lt;Entry&amp;lt;K,V&amp;gt;&amp;gt; i = entrySet().iterator();11">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/1024555/201611/1024555-20161113235348670-746615111.png">
<meta property="og:updated_time" content="2024-11-18T05:41:34.317Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="HashMap相关">
<meta name="twitter:description" content="HashMap继承AbstractMap，而AbstractMap实现了map接口 123456789101112131415161718110111    public boolean containsValue(Object value) &amp;#123;112        Iterator&amp;lt;Entry&amp;lt;K,V&amp;gt;&amp;gt; i = entrySet().iterator();11">
<meta name="twitter:image" content="http://images2015.cnblogs.com/blog/1024555/201611/1024555-20161113235348670-746615111.png">
  
    <link rel="alternate" href="/atom.xml" title="Vencent Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
</head>
</html>
  
    <body>
  
      <div id="container" class="container">
        <article id="post-HashMap" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav id="main-nav" class="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HashMap相关
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <p>HashMap继承AbstractMap，而AbstractMap实现了map接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">110</span></span><br><span class="line"><span class="number">111</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line"><span class="number">112</span>        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line"><span class="number">113</span>        <span class="keyword">if</span> (value==<span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">114</span>            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line"><span class="number">115</span>                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line"><span class="number">116</span>                <span class="keyword">if</span> (e.getValue()==<span class="keyword">null</span>)</span><br><span class="line"><span class="number">117</span>                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">118</span>            &#125;</span><br><span class="line"><span class="number">119</span>        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">120</span>            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line"><span class="number">121</span>                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line"><span class="number">122</span>                <span class="keyword">if</span> (value.equals(e.getValue()))</span><br><span class="line"><span class="number">123</span>                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">124</span>            &#125;</span><br><span class="line"><span class="number">125</span>        &#125;</span><br><span class="line"><span class="number">126</span>        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">127</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>key  和value都可以为null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">452</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"><span class="number">453</span>        <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line"><span class="number">454</span>            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">455</span></span><br><span class="line"><span class="number">456</span>        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line"><span class="number">457</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">458</span>        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line"><span class="number">459</span>        <span class="keyword">if</span> (m.size() != size())</span><br><span class="line"><span class="number">460</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">461</span></span><br><span class="line"><span class="number">462</span>        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">463</span>            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line"><span class="number">464</span>            <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line"><span class="number">465</span>                Entry&lt;K,V&gt; e = i.next();</span><br><span class="line"><span class="number">466</span>                K key = e.getKey();</span><br><span class="line"><span class="number">467</span>                V value = e.getValue();</span><br><span class="line"><span class="number">468</span>                <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">469</span>                    <span class="keyword">if</span> (!(m.get(key)==<span class="keyword">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line"><span class="number">470</span>                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">471</span>                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">472</span>                    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line"><span class="number">473</span>                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">474</span>                &#125;</span><br><span class="line"><span class="number">475</span>            &#125;</span><br><span class="line"><span class="number">476</span>        &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line"><span class="number">477</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">478</span>        &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line"><span class="number">479</span>            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">480</span>        &#125;</span><br><span class="line"><span class="number">481</span></span><br><span class="line"><span class="number">482</span>        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">483</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>equals方法被重写，除了对比是否同一个对象，如果不是，还得对齐key，还有value的equals方法比较value</p>
<p>所以可以注重value类型的equal方法的重写</p>
<p>当都保持对齐，返回true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">502</span></span><br><span class="line"><span class="number">503</span>    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">504</span>        <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line"><span class="number">505</span>        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line"><span class="number">506</span>        <span class="keyword">while</span> (i.hasNext())</span><br><span class="line"><span class="number">507</span>            h += i.next().hashCode();</span><br><span class="line"><span class="number">508</span>        <span class="keyword">return</span> h;</span><br><span class="line"><span class="number">509</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>哈希是子项哈希的和</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">548</span></span><br><span class="line"><span class="number">549</span>    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line"><span class="number">550</span>        AbstractMap&lt;?,?&gt; result = (AbstractMap&lt;?,?&gt;)<span class="keyword">super</span>.clone();</span><br><span class="line"><span class="number">551</span>        result.keySet = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">552</span>        result.values = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">553</span>        <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">554</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>克隆浅拷贝，不拷贝keyvalues</p>
<p>eq方法写的有意思</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">561</span></span><br><span class="line"><span class="number">562</span>    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">eq</span><span class="params">(Object o1, Object o2)</span> </span>&#123;</span><br><span class="line"><span class="number">563</span>        <span class="keyword">return</span> o1 == <span class="keyword">null</span> ? o2 == <span class="keyword">null</span> : o1.equals(o2);</span><br><span class="line"><span class="number">564</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>put方法等待被重写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">207</span></span><br><span class="line"><span class="number">208</span>    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line"><span class="number">209</span>        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line"><span class="number">210</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>内部类SimpleEntry，SimpleImmutableEntry实现了map接口内部接口entry</p>
<h1 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h1><p>先要知道啥叫哈希表，给定表M，存在函数f(key)，对任意给定的关键字值key，代入函数后若能得到包含该关键字的记录在表中的地址，则称表M为哈希(Hash）表，函数f(key)为哈希(Hash) 函数。</p>
<p>map 被存储在桶的哈希表里。（每个表单位就是一个桶），但是当桶已经满了时候，当前的桶会转化成树节点。数据结构类似Tree Map，在哈希表里面，尽可能只用正常的桶，每个桶的数据结构也可能被转化成树节点。桶上的节点会被遍历和使用，跟哈希表非树节点的保持平级。当数量过大，查找会更快（因为通过hash得到桶的index，时间复杂度只有O（1）,而如果当前桶的数据结构为链表节点（树节点）时，再通过链表查找O（n））</p>
<p>在定位桶的index用到map的key的hashcode函数，而如果桶为多节点链表时，则通过key的equal函数找到位置。</p>
<p>盗图–&gt;</p>
<p><img src="http://images2015.cnblogs.com/blog/1024555/201611/1024555-20161113235348670-746615111.png" alt="HashMap"></p>
<p>四个构造函数，从无参构造入口，只设置了加载因子，DEFAULT_LOAD_FACTOR=0.75</p>
<p>然后看put方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">609</span> </span><br><span class="line"><span class="number">610</span>     <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line"><span class="number">611</span>         <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">612</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>hash方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">335</span> </span><br><span class="line"><span class="number">336</span>     <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="number">337</span>         <span class="keyword">int</span> h;</span><br><span class="line"><span class="number">338</span>         <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line"><span class="number">339</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>putVal方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">623</span> </span><br><span class="line"><span class="number">624</span>     <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">625</span>                    <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line"><span class="number">626</span>         Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line"><span class="number">627</span>         <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line"><span class="number">628</span>             n = (tab = resize()).length;</span><br><span class="line"><span class="number">629</span>         <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">630</span>             tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">631</span>         <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">632</span>             Node&lt;K,V&gt; e; K k;</span><br><span class="line"><span class="number">633</span>             <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line"><span class="number">634</span>                 ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line"><span class="number">635</span>                 e = p;</span><br><span class="line"><span class="number">636</span>             <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line"><span class="number">637</span>                 e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line"><span class="number">638</span>             <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">639</span>                 <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line"><span class="number">640</span>                     <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">641</span>                         p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">642</span>                         <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line"><span class="number">643</span>                             treeifyBin(tab, hash);</span><br><span class="line"><span class="number">644</span>                         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">645</span>                     &#125;</span><br><span class="line"><span class="number">646</span>                     <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line"><span class="number">647</span>                         ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line"><span class="number">648</span>                         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">649</span>                     p = e;</span><br><span class="line"><span class="number">650</span>                 &#125;</span><br><span class="line"><span class="number">651</span>             &#125;</span><br><span class="line"><span class="number">652</span>             <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line"><span class="number">653</span>                 V oldValue = e.value;</span><br><span class="line"><span class="number">654</span>                 <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">655</span>                     e.value = value;</span><br><span class="line"><span class="number">656</span>                 afterNodeAccess(e);</span><br><span class="line"><span class="number">657</span>                 <span class="keyword">return</span> oldValue;</span><br><span class="line"><span class="number">658</span>             &#125;</span><br><span class="line"><span class="number">659</span>         &#125;</span><br><span class="line"><span class="number">660</span>         ++modCount;</span><br><span class="line"><span class="number">661</span>         <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line"><span class="number">662</span>             resize();</span><br><span class="line"><span class="number">663</span>         afterNodeInsertion(evict);</span><br><span class="line"><span class="number">664</span>         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">665</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>第一次进来会调用resize方法，让tab初始化和n作为tab长度初始化(627)</p>
<p>resize方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line"><span class="number">677</span>         Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line"><span class="number">678</span>         <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line"><span class="number">679</span>         <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line"><span class="number">680</span>         <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line"><span class="number">681</span>         <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">682</span>             <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line"><span class="number">683</span>                 threshold = Integer.MAX_VALUE;</span><br><span class="line"><span class="number">684</span>                 <span class="keyword">return</span> oldTab;</span><br><span class="line"><span class="number">685</span>             &#125;</span><br><span class="line"><span class="number">686</span>             <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line"><span class="number">687</span>                      oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line"><span class="number">688</span>                 newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line"><span class="number">689</span>         &#125;</span><br><span class="line"><span class="number">690</span>         <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line"><span class="number">691</span>             newCap = oldThr;</span><br><span class="line"><span class="number">692</span>         <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line"><span class="number">693</span>             newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line"><span class="number">694</span>             newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line"><span class="number">695</span>         &#125;</span><br><span class="line"><span class="number">696</span>         <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">697</span>             <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line"><span class="number">698</span>             newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line"><span class="number">699</span>                       (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"><span class="number">700</span>         &#125;</span><br><span class="line"><span class="number">701</span>         threshold = newThr;</span><br><span class="line"><span class="number">702</span>         <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line"><span class="number">703</span>             Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line"><span class="number">704</span>         table = newTab;</span><br><span class="line"><span class="number">705</span>         <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">706</span>             <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line"><span class="number">707</span>                 Node&lt;K,V&gt; e;</span><br><span class="line"><span class="number">708</span>                 <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">709</span>                     oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">710</span>                     <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">711</span>                         newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line"><span class="number">712</span>                     <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line"><span class="number">713</span>                         ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line"><span class="number">714</span>                     <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line"><span class="number">715</span>                         Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">716</span>                         Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">717</span>                         Node&lt;K,V&gt; next;</span><br><span class="line"><span class="number">718</span>                         <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">719</span>                             next = e.next;</span><br><span class="line"><span class="number">720</span>                             <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">721</span>                                 <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">722</span>                                     loHead = e;</span><br><span class="line"><span class="number">723</span>                                 <span class="keyword">else</span></span><br><span class="line"><span class="number">724</span>                                     loTail.next = e;</span><br><span class="line"><span class="number">725</span>                                 loTail = e;</span><br><span class="line"><span class="number">726</span>                             &#125;</span><br><span class="line"><span class="number">727</span>                             <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">728</span>                                 <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">729</span>                                     hiHead = e;</span><br><span class="line"><span class="number">730</span>                                 <span class="keyword">else</span></span><br><span class="line"><span class="number">731</span>                                     hiTail.next = e;</span><br><span class="line"><span class="number">732</span>                                 hiTail = e;</span><br><span class="line"><span class="number">733</span>                             &#125;</span><br><span class="line"><span class="number">734</span>                         &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line"><span class="number">735</span>                         <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">736</span>                             loTail.next = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">737</span>                             newTab[j] = loHead;</span><br><span class="line"><span class="number">738</span>                         &#125;</span><br><span class="line"><span class="number">739</span>                         <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">740</span>                             hiTail.next = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">741</span>                             newTab[j + oldCap] = hiHead;</span><br><span class="line"><span class="number">742</span>                         &#125;</span><br><span class="line"><span class="number">743</span>                     &#125;</span><br><span class="line"><span class="number">744</span>                 &#125;</span><br><span class="line"><span class="number">745</span>             &#125;</span><br><span class="line"><span class="number">746</span>         &#125;</span><br><span class="line"><span class="number">747</span>         <span class="keyword">return</span> newTab;</span><br><span class="line"><span class="number">748</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>Node内部类实现了Map.Entry，查看equal方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"><span class="number">306</span>             <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line"><span class="number">307</span>                 <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">308</span>             <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line"><span class="number">309</span>                 Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class="line"><span class="number">310</span>                 <span class="keyword">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class="line"><span class="number">311</span>                     Objects.equals(value, e.getValue()))</span><br><span class="line"><span class="number">312</span>                     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">313</span>             &#125;</span><br><span class="line"><span class="number">314</span>             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">315</span>         &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法对链表寻址似乎没有影响</p>
<p>回头看resize方法，如果哈希表的长度已经超出了MAXIMUM_CAPACITY，threshold会被赋值为Integer的最大值</p>
<p>而这个threshold就是下次扩容的值，capacity * load factor 的结果值</p>
<p>686：如果旧的长度没有超出哈希表的默认最长长度，首先就是长度翻倍扩容</p>
<p> 而如果翻倍后，还是没有超过默认最长哈希长度，并且旧的长度大于等于初始长度，那么设置下次扩容，应该为两倍扩容</p>
<p>690如果旧的长度小于等于0，那么新的长度设置为扩容值。</p>
<p>693默认其他情况，</p>
<p>681-695总结：第一次进来，会初始化哈希表的长度为初始长度，下次扩容为capacity * load factor 的结果值</p>
<p>而如果表长度不够的时候，会进行翻倍，并且下次扩容的threshold也翻倍，直到超过最大值，如果超过最大值，下次扩容直接就是Integer最大值。</p>
<p>705开始进行一个扩容拷贝操作</p>
<p>treenode部分还未知，先略过</p>
<p>再返回上一层，查看putVal方法</p>
<p>629这行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>新节点的位置通过这两句就确定下来了，确定的位置i，i的决定因素有hash整形数，和n，哈希表的长度减一，一个与运算，保证了位置一定在哈希表的范围内，并且位置和hash相关。如果在这个位置已经有了p!=null。说明hash一致。就不会new对象，如果没有，就执行了newNode方法</p>
<p>查看一下newNode方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">1725     * The following package-protected methods are designed to be</span></span><br><span class="line"><span class="comment">1726     * overridden by LinkedHashMap, but not by any other subclass.</span></span><br><span class="line"><span class="comment">1727     * Nearly all other internal methods are also package-protected</span></span><br><span class="line"><span class="comment">1728     * but are declared final, so can be used by LinkedHashMap, view</span></span><br><span class="line"><span class="comment">1729     * classes, and HashSet.</span></span><br><span class="line"><span class="comment">1730     */</span></span><br><span class="line"><span class="number">1732</span>    <span class="comment">// Create a regular (non-tree) node</span></span><br><span class="line"><span class="number">1733</span>    <span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class="line"><span class="number">1734</span>        <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(hash, key, value, next);</span><br><span class="line"><span class="number">1735</span>    &#125;</span><br></pre></td></tr></table></figure>
<p>啥玩意，给LinkedHashMap用的？</p>
<p>如果哈希表，当前桶已经有值了，那么走632逻辑</p>
<p>633判断新来的节点是不是跟已经占桶的节点的哈希值保持一致，并且key一致，（key一致，要么key就是同一个对象，要么key不是null，equal方法的出来的结果一致）所以这时候，新的节点，就是认为老的节点。这边value的hash或者equal不拿来判断的。</p>
<p>636如果当前桶是treenode类型，就把新来的节点添加到treenode，首部。看putTreeVal方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1958</span></span><br><span class="line"><span class="number">1959</span>        <span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">1960</span>                                       <span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line"><span class="number">1961</span>            Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">1962</span>            <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">1963</span>            TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line"><span class="number">1964</span>            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line"><span class="number">1965</span>                <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line"><span class="number">1966</span>                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line"><span class="number">1967</span>                    dir = -<span class="number">1</span>;</span><br><span class="line"><span class="number">1968</span>                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line"><span class="number">1969</span>                    dir = <span class="number">1</span>;</span><br><span class="line"><span class="number">1970</span>                <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line"><span class="number">1971</span>                    <span class="keyword">return</span> p;</span><br><span class="line"><span class="number">1972</span>                <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">1973</span>                          (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line"><span class="number">1974</span>                         (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">1975</span>                    <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line"><span class="number">1976</span>                        TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line"><span class="number">1977</span>                        searched = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">1978</span>                        <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">1979</span>                             (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line"><span class="number">1980</span>                            ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">1981</span>                             (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line"><span class="number">1982</span>                            <span class="keyword">return</span> q;</span><br><span class="line"><span class="number">1983</span>                    &#125;</span><br><span class="line"><span class="number">1984</span>                    dir = tieBreakOrder(k, pk);</span><br><span class="line"><span class="number">1985</span>                &#125;</span><br><span class="line"><span class="number">1986</span></span><br><span class="line"><span class="number">1987</span>                TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line"><span class="number">1988</span>                <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">1989</span>                    Node&lt;K,V&gt; xpn = xp.next;</span><br><span class="line"><span class="number">1990</span>                    TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line"><span class="number">1991</span>                    <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="number">1992</span>                        xp.left = x;</span><br><span class="line"><span class="number">1993</span>                    <span class="keyword">else</span></span><br><span class="line"><span class="number">1994</span>                        xp.right = x;</span><br><span class="line"><span class="number">1995</span>                    xp.next = x;</span><br><span class="line"><span class="number">1996</span>                    x.parent = x.prev = xp;</span><br><span class="line"><span class="number">1997</span>                    <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line"><span class="number">1998</span>                        ((TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line"><span class="number">1999</span>                    moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line"><span class="number">2000</span>                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">2001</span>                &#125;</span><br><span class="line"><span class="number">2002</span>            &#125;</span><br><span class="line"><span class="number">2003</span>        &#125;</span><br></pre></td></tr></table></figure>
<p>如果当前节点不是根节点，就去找根节点，不然当前节点就是作为根节点</p>
<p>root方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1803</span></span><br><span class="line"><span class="number">1804</span>        <span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">root</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="number">1805</span>            <span class="keyword">for</span> (TreeNode&lt;K,V&gt; r = <span class="keyword">this</span>, p;;) &#123;</span><br><span class="line"><span class="number">1806</span>                <span class="keyword">if</span> ((p = r.parent) == <span class="keyword">null</span>)</span><br><span class="line"><span class="number">1807</span>                    <span class="keyword">return</span> r;</span><br><span class="line"><span class="number">1808</span>                r = p;</span><br><span class="line"><span class="number">1809</span>            &#125;</span><br><span class="line"><span class="number">1810</span>        &#125;</span><br></pre></td></tr></table></figure>
<p>生名了两个变量r,p。r被赋值为this，p为null值。沿着r，开始找到parent为null的时候，表明找到了根节点。</p>
<p>（真担心这里会死循环，但是并不会~）</p>
<p>返回putTreeVal方法</p>
<p>找到根节点之后，1966行，拿根节点的hash和入桶节点的hash进行比对，如果大于dir=-1，如果小于dir=1</p>
<p>如果等于，则判断key是不是一样（根节点的key是不是同一个对象或者equal方法返回是不是true），如果是就表明，已经在桶的节点就是要入的节点。返回当前节点;</p>
<p>如果key不一样，说明hash一样，但是key不一样，说明hash冲突了。</p>
<p>当hash冲突的时候，可以进入下一个if逻辑体满足其中一个情况：</p>
<p>情况一：kc==null并且comparableClassFor，方法也返回null。</p>
<p>查看comparableClassFor方法，只要key不是Compareable就返回null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">345</span>     <span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line"><span class="number">346</span>         <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;</span><br><span class="line"><span class="number">347</span>             Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line"><span class="number">348</span>             <span class="keyword">if</span> ((c = x.getClass()) == String<span class="class">.<span class="keyword">class</span>) // <span class="title">bypass</span> <span class="title">checks</span></span></span><br><span class="line"><span class="class">349                 <span class="title">return</span> <span class="title">c</span></span>;</span><br><span class="line"><span class="number">350</span>             <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">351</span>                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;</span><br><span class="line"><span class="number">352</span>                     <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;</span><br><span class="line"><span class="number">353</span>                         ((p = (ParameterizedType)t).getRawType() ==</span><br><span class="line"><span class="number">354</span>                          Comparable<span class="class">.<span class="keyword">class</span>) &amp;&amp;</span></span><br><span class="line"><span class="class">355                         (<span class="title">as</span> </span>= p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line"><span class="number">356</span>                         as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c) <span class="comment">// type arg is c</span></span><br><span class="line"><span class="number">357</span>                         <span class="keyword">return</span> c;</span><br><span class="line"><span class="number">358</span>                 &#125;</span><br><span class="line"><span class="number">359</span>             &#125;</span><br><span class="line"><span class="number">360</span>         &#125;</span><br><span class="line"><span class="number">361</span>         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">362</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>对这个方法的介绍<a href="http://blog.csdn.net/leeqihe/article/details/76461442" target="_blank" rel="noopener">参考</a></p>
<p>getGenericInterfaces()</p>
<p>方法返回的是该对象的运行时类型“直接实现”的接口，这意味着：<br>返回的一定是接口。必然是该类型自己实现的接口，继承过来的不算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class&lt;?&gt; comparableClassFor(Object x) &#123;</span><br><span class="line">       <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Comparable) &#123;  <span class="comment">// 判断是否实现了Comparable接口</span></span><br><span class="line">           Class&lt;?&gt; c; Type[] ts, as; Type t; ParameterizedType p;</span><br><span class="line">           <span class="keyword">if</span> ((c = x.getClass()) == String<span class="class">.<span class="keyword">class</span>) </span></span><br><span class="line"><span class="class">               <span class="title">return</span> <span class="title">c</span></span>;   <span class="comment">// 如果是String类型，直接返回String.class</span></span><br><span class="line">           <span class="keyword">if</span> ((ts = c.getGenericInterfaces()) != <span class="keyword">null</span>) &#123;  <span class="comment">// 判断是否有直接实现的接口</span></span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ts.length; ++i) &#123;   <span class="comment">// 遍历直接实现的接口</span></span><br><span class="line">                   <span class="keyword">if</span> (((t = ts[i]) <span class="keyword">instanceof</span> ParameterizedType) &amp;&amp;   <span class="comment">// 该接口实现了泛型</span></span><br><span class="line">                       ((p = (ParameterizedType)t).getRawType() == <span class="comment">// 获取接口不带参数部分的类型对象</span></span><br><span class="line">                        Comparable<span class="class">.<span class="keyword">class</span>) &amp;&amp;   //  该类型是<span class="title">Comparable</span></span></span><br><span class="line"><span class="class">                       (<span class="title">as</span> </span>= p.getActualTypeArguments()) != <span class="keyword">null</span> &amp;&amp;    <span class="comment">// 获取泛型参数数组</span></span><br><span class="line">                       as.length == <span class="number">1</span> &amp;&amp; as[<span class="number">0</span>] == c)   <span class="comment">// 只有一个泛型参数，且该实现类型是该类型本身</span></span><br><span class="line">                       <span class="keyword">return</span> c;   <span class="comment">// 返回该类型</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>返回putTreeVal</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">367</span> </span><br><span class="line"><span class="number">368</span>     <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;) <span class="comment">// for cast to Comparable</span></span><br><span class="line"><span class="number">369</span>     <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareComparables</span><span class="params">(Class&lt;?&gt; kc, Object k, Object x)</span> </span>&#123;</span><br><span class="line"><span class="number">370</span>         <span class="keyword">return</span> (x == <span class="keyword">null</span> || x.getClass() != kc ? <span class="number">0</span> :</span><br><span class="line"><span class="number">371</span>                 ((Comparable)k).compareTo(x));</span><br><span class="line"><span class="number">372</span>     &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/10/25/HashMap/" class="article-date">
  <time datetime="2017-10-25T15:00:58.000Z" itemprop="datePublished">2017-10-25</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/">code</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2017/10/27/红黑树介绍/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          红黑树介绍
        
      </div>
    </a>
  
  
    <a href="/2017/10/25/Map接口概览/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Map相关</div>
    </a>
  
</nav>


  
</article>




      </div>
      
    <footer id="footer" class="post-footer footer">
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>老铁，我是底线</p>


      </div>
    </footer>

      

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
